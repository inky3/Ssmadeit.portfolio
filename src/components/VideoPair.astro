---
interface Item {
  title: string;
  thumb: string;
  src?: string;
  embed?: "youtube" | "vimeo" | "tiktok" | "instagram" | "facebook" | null;
}

const { heading = "Videos", items = [] as Item[], id = "videos" } = Astro.props;

const buildSrc = (it: Item) => {
  if (!it.embed) return ""; // local mp4

  if (it.embed === "youtube")
    return `https://www.youtube.com/embed/${it.src}?autoplay=1&mute=1&rel=0`;

  if (it.embed === "vimeo")
    return `https://player.vimeo.com/video/${it.src}?autoplay=1&muted=1`;

  if (it.embed === "tiktok")
    return `https://www.tiktok.com/embed/v2/${it.src}`;

  if (it.embed === "instagram")
    return `https://www.instagram.com/reel/${it.src}/embed`;

  if (it.embed === "facebook")
    return `https://www.facebook.com/plugins/video.php?href=${encodeURIComponent(
      it.src || ""
    )}&show_text=false&width=960`;

  return "";
};
---

<section id={id} class="section">
  <div class="container">
    <h2 class="h2">{heading}</h2>

    <div class="grid grid-2">
      {items.map((it, idx) => (
        <figure class="card" style="padding:12px">

          <!-- Auto aspect ratio here -->
          <div
            class="media"
            data-idx={idx}
            style={`background:#111;aspect-ratio:${
              it.embed === "tiktok" || it.embed === "instagram" ? "3 / 4" : "16 / 9"
            }`}
          >

            <!-- Click-to-play -->
            <button
              class="vp-play"
              style="
                all:unset; cursor:pointer; display:block; width:100%; height:100%;
                position:relative;
              "
              onclick={`(function(){
                const wrap = event.currentTarget.parentElement;
                if(!wrap || wrap.dataset.playing === '1') return;
                wrap.dataset.playing = '1';

                const provider = ${JSON.stringify(items)}[${idx}].embed;
                const src      = "${buildSrc(it)}";
                const isLocal  = ${JSON.stringify(!it.embed)};
                let node;

                if (isLocal) {
                  node = document.createElement('video');
                  node.src = ${JSON.stringify(it.src || "")};
                  node.controls = true;
                  node.autoplay = true;
                  node.playsInline = true;
                  node.muted = true;
                  node.style = "width:100%;height:100%;display:block;object-fit:cover;";
                } else {
                  node = document.createElement('iframe');
                  node.src = src;
                  node.allow = "autoplay; encrypted-media; clipboard-write; picture-in-picture; web-share";
                  node.allowFullscreen = true;
                  node.style = "width:100%;height:100%;border:0;display:block;object-fit:cover;";
                }

                wrap.innerHTML = "";
                wrap.appendChild(node);

                const fbURL = (provider === 'facebook' || provider === 'instagram' || provider === 'tiktok')
                  ? ${JSON.stringify(it.src || "")}
                  : '';

                let opened = false;
                const fallback = () => {
                  if(opened) return;
                  opened = true;
                  wrap.innerHTML = '<div style="display:flex;justify-content:center;align-items:center;flex-direction:column;background:#000;height:100%;border-radius:12px;color:#fff;padding:16px;text-align:center"><p style="opacity:.9;margin:0 0 12px">This video can’t be embedded here.</p><a class="btn" target="_blank" href="'+fbURL+'">Open on platform</a></div>';
                };

                if (!isLocal) {
                  const timer = setTimeout(fallback, 6000);
                  node.addEventListener?.('load', () => clearTimeout(timer));
                  node.addEventListener?.('error', fallback);
                }
              })()`}
            >

              <img
                src={it.thumb}
                alt={it.title}
                loading="lazy"
                style="position:absolute;inset:0;width:100%;height:100%;object-fit:cover;filter:brightness(.85)"
              />

              <span
                style="
                  position:absolute;left:12px;bottom:12px;
                  background:rgba(0,0,0,.55); color:#fff; border-radius:999px;
                  padding:8px 12px; font-weight:600; backdrop-filter:saturate(140%) blur(4px);
                "
              >▶ Play</span>

            </button>
          </div>

          <figcaption style="margin-top:10px">{it.title}</figcaption>

        </figure>
      ))}
    </div>
  </div>
</section>
